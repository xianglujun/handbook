# 基本概念

## 文档(Document)

- es 是面向文档的，文档是所有可搜索数据的最小单元
  - 日志内容
  - 电影基础信息，影片介绍等
- 文档会被序列化成JSON格式，保存在es中
- 每个文档都有一个唯一ID标识(Unique ID)



### JSON文档

- 一个文档包含了一列的字段
- JSON文档，格式灵活，不需要预定义格式
  - 字段类型可以指定或者通过ES自动推算
  - 支持数组/支持嵌套

### 文档的元数据

- 元数据，用于标识文档的相关信息
  - _index - 文档所属的索引名
  - _type - 文档所属的类型名
  - _id - 文档唯一ID
  - _source: 文档的原始JSON数据
  - _all: 整合所有字段内容到该字段(在7版本之后，已废除)
  - _version: 文档的版本信息
  - _score: 相关性打分



## 索引(Index)

- Index - 所以是文档的容器，是一类文档的结合
  - Index提现了逻辑空间的概念：每个所有都有自己的Mapping定义，用于定义包含的文档的字段名和字段类型
  - Shard 提现了物理空间的概念：索引中的数据分散在Shard上
- 索引的Mapping与Settings
  - Mapping 定义文档字段的类型
  - Setting定义不同的数据分布, 定义了分片的数量，以及数据的分布



## Type

- 在7.0之前，一个Index可以设置多个Types
- 6.0开始，Type已经被废除，从7.0一开始，一个索引只能创建一个Type - "_doc"



## 节点(Node)

- 节点是一个ES实例
  - 本质上就是一个JAVA进程
  - 一台机器删够可以运行多个ES进程，但是生产环境建议一台机器只运行一个ES实例
- 每个节点都有名字，通过配置文件配置 或者通过`-E node.name=node1`指定
- 每个节点在启动之后，会分配一个UID, 保存在ES 安装目录 data目录下



## Master-eligible nodes 和Master Node

- 每个节点启动后，默认就是Master eligible节点
  - 可以设置`node.master: false`禁止
- Master-eligible节点可以参加选主流程，成为Master节点
- 当第一个节点启动的时候，会选举自己成为Master节点
- 每个节点上都保存了集群的状态，只有Master节点才能修改集群的状态信息
  - 集群状态(Cluster State), 维护了一个集群中，必要的信息
    - 所有的节点信息
    - 所有的索引和其他相关的Mapping与Setting信息
    - 分片的路由信息
  - 任意节点都能修改信息会导致数据的不一致



## Data Node 与 Coordinating Node

- Data Node
  - 可以保存数据的节点，负责保存分片的数据，在数据扩展上起到了至关重要的作用
- Coordinating Node
  - 负责接收Client的请求，将请求分发到合适的节点，最终把结果汇集到一起
  - 每个节点默认都起到了Coordinating Node 的职责



## 其他的节点类型

- Hot 与Warm Node
  - 不同硬件配置的Data Node, 用来实现 Hot & Warm架构，降低集群部署的成本
- Machine Learning Node
  - 负责运行机器学习Job，实现异常检测
- Tribe Node
  - Tribe Node链接到不同的ES集群, 并且支持将这些集群当成一个单独的集群处理。



## 分片(Primary Shard & Replica Shard)

- Primary Shard(主分片)
  - 用于解决数据水平扩展的问题，通过注分片，可以将数据分布到集群内的所有节点之上
  - 一个分片是一个运行的Lucene的实例
  - 主分片数在索引创建时指定，后续不允许修改，除非`Reindex`
- Replica Shard (副本)
  - 用以解决数据高可用的问题，分片是主分片的拷贝
  - 副本分片数，可以动态调整
  - 增加副本数，还是可以在一定程度上提高服务的可用性



## 分片的设定

- 对于生产环境中的设定，需要提前做好容量规划
  - 分片数设置过小
    - 导致后续无法增加节点实现水平扩展
    - 单个分片的数据量太大，导致数据重新分配耗时
  - 分片数设置过大，从7.0开始，默认主分片设置为1, 解决了`over-sharding`的问题
    - 影响所有结果的相关性打分，影响统计结果的准确性
    - 单个节点上过多的分片，会导致资源浪费，同事也会影响性能



## 健康状况说明

- `Green` - 主分片与副本都正常分配
- `Yellow` - 主分片全部正常, 有副本分片未能正常分配
- `Red` - 有主分片未能分配

## 特性

### 可用性与扩展性

- 高可用行
  - 服务可用性- 允许服务节点停止服务
  - 数据可用性 - 部分节点丢失，不会丢失数据
- 可扩展性
  - 请求量提升/数据的不断增长(将数据分布到所有节点上)

### 分布是特性

- ES 分布式架构的好处
  - 存储的水平扩容
  - 提高系统的可用性，部分节点停止服务，整个集群不受影响
- ES 的分布式架构
  - 不同的集群通过不同的名字来区分
  - 通过配置文件修改，或者在命令航中 `-E cluster.name=test`进行设定
  - 一个集群可以有一个或者多个节点



## ES与关系型数据库之间的类比

| RDBMS  | ES       |
| ------ | -------- |
| Table  | Index    |
| Row    | Document |
| Column | Field    |
| Schema | Mapping  |
| SQL    | DSL      |

