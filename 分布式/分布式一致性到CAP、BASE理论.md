# 分布式一致性的提出
在分布式系统中要解决的一个中央问题就是数据的复制。

分布式系统对于数据复制需求一般都来自于以下两个原因:
1. 为了增加系统的可用性, 以防止单点故障引起的系统不可用
2. 提高系统的整体性能, 通过负载均衡技术, 能够让分布在不同地方的数据副本都能为用户提供服务。

## 分布一致性概念
所谓分布一致性问题, 是指在分布环境中引入数据复制机制之后, 不同数据节点之间可能出现的, 并无法依靠计算机程序自身解决数据不一致的情况。简单讲, 数据一致性就是指在对一个副本数据进行更新的时候, 必须确保也能够更新其他副本。否则不同副本之间的数据将不一致。

### 分布一致性如何解决?
1. 既然是由于演示动作引起的问题, 那我可以将写入的动作阻塞, 直到数据复制完成后, 才完成写入动作.(`但是该思路在解决一致性的同时, 带来了写入性能问题。如果应用场景非常多的写请求, 那么将会有许多后期请求将会阻塞在一个请求的写操作上, 导致系统整个性能急剧下降`)

### 一致性分类
1. 强一致性
> 这种一致性级别是最符合用户直觉的, 它要求系统写入什么, 读出来就是什么，用户体验好, 但是实现起来往往对系统的性能影响大

2. 弱一致性
> 这种一致性级别约束了系统在写入成功后, 不承诺立即可以读到写入的值, 也不承诺多久之后数据能够达到一致性，但会尽可能地保证某个时间级别后, 数据能够达到一致状态

3. 最终一致性
> 最终一致性是弱一致性的一个特例, 系统会保证在一定时间内, 能够达到一个数据一致的状态。

### 分布式环境的各种问题
分布式系统体系结构从其出现就伴随着诸多的难题和挑战:
1. 通信异常
从集中式向分布式演变的过程中, 必然引入网络因素, 由于网络本身的不可靠性, 因此也引入了额外的问题。分布式系统需要在各个节点之间进行网络通信, 因此每次网络通信都会伴随着网络不可用的风险。
同时, 即使分布式系统各个节点之间的网络通信能够正常运行, 其延时也会大于单机操作。

2. 网络分区
当网络由于发生异常情况, 导致分布式系统中部分节点之间的网络延时不断增大, 最终导致组成分布式系统的所有节点中, 只有部分节点能够正常通信, 而另外一些节点则不能--我们将这种详情成为网络分区.当网络分区出现时, 分布式系统会出现局部小集群, 在极端情况下, 这些小集群会独立完成原本需要整个分布式系统才能完成的功能, 包括对数据的事务处理, 这就对分布式一致性提出了非常大的挑战。

3. 三态
上面两点, 我们已经了解到在分布式环境下, 网络坑内会出现格式各样的问题, 因此分布式系统每一次请求与响应, 存在特有的三态概念， 即成功, 失败，超时。在传统的单机系统中, 应用程序调用一个函数之后, 能够得到一个非常明确的响应: `成功或失败`
`而在分布式环境中, 由于网络是不可靠的, 虽然在绝大部分情况下, 网络通信也能够接收到成功或失败的响应, 当时当网络出现异常的情况下, 就可能出现超时现象, 导致以下两种情况:`
- 由于网络原因，该请求并没有被成功地发送到接收方, 而是在发送过程中就发生了消息丢失现象
- 该请求成功地被接收方接收后, 进行了处理, 但是在讲响应反馈给发送方的过程中, 发生了消息丢失现象.

4. 节点故障
节点故障则是分布式环境下另一个比较常见的问题, 指的是组成分布式系统的服务器节点出现的宕机或"僵尸"萱萱变更，通常根据经验来说, 每个节点都有可能出现故障, 并且每天都在发生.

## 分布式事务
分布式事务是指事务的参与者, 支持事务的服务器, 资源服务器以及事务管理器分别位于分布式系统的不同节点上, 通常一个分布式事务中会设计对多个数据源业务系统的操作.

## CAP理论
一个经典的分布式系统理论. CAP理论告诉我们: 一个分布式系统不可能同时满足一致性(C:Consistency), 可用性(A:Availiablity)和分区容错性(P:Partion tolerance)这三个基本需求, 最多只能同时满足两个.

1. 一致性
在分布式环境下, 一致性是指数据在多个副本之间能否保持一致的特性。在一致性的需求下, 当一个系统在数据一致的状态下执行更新操作后, 应该保证系统的数据仍然处于一致的状态.
对于一个将数据副本分布在不同分布式节点上的系统来说, 如果对第一个节点的数据进行了更新操作并且更新成功后, 却没有使得第二个节点沙河过女的数据的到相应的更新, 于是在对第二个节点的数据记性读取时, 获取的依然是老数据, 这就是典型的分布式数据不一致的情况。在分布式系统中, 如果能够做到针对一个数据项的更新操作执行成功后, 所有的用户都可以读取到其最新的值, 那么这样的系统就被认为具有强一致性。

2. 可用性
可用性是指系统提供的服务必须一致处于可用状态, 对于用户的每一个操作请求总是能够在优先的时间内返回结果。这里的重点是`有限时间`和`返回结果`
`有限时间`是指, 对于用户的一个操作请求, 系统必须能够在指定时间内返回对应的处理结果, 如果超过了这个时间范围, 那么系统就被认为是不可用。另外, `有限时间内`是指系统设计之初就设计好的运行指标, 通常不同系统之间有很大的不同, 无论如何, 对于用户请求, 系统必须存在一个合理的响应时间, 否则将会影响用户体验.
`返回结果`是可用性的另一个非常重要的指标, 它要求系统在完成对用户请求的处理后, 返回一个正常的响应结果. 正常的额响应结果通常能够明确地反应出对请求的处理结果, 即成功或失败，而不是一个让用户感到困惑的返回结果.

3.  分区容错性
分区容错性约束了一个分布式系统具有如下特性:`分布式系统哎遇到任何网络分区故障的时候, 仍然需要能够保证对外提供满足一致性和可用性的服务, 除非是整个网络环境发生了故障`

网络分区是指在分布式系统中,不同的节点处在不同的子网络中, 由于一些特殊的原因导致这些子网络出现网络不连通的状况, 单哥哥子网络的内部网络是正常的, 从而导致真个系统的网络环境被切分成了若干个孤立的区域。需要注意的是, 组成一个分布式系统的每个节点的加入与退出都可以看做是一个特殊的网络分区。

|选择|说明|
|:---|:---|
|CA   |放弃分区容错性, 加强一致性和可用性, 其实就是传统的单机数据的选择   |
|AP   |放弃一致性(这里说的一致性是强一致性), 追求分区容错性和可用性, 这是很多分布式系统设计时的选择   |
|CP   |放弃可用性, 追求一致性和分区容错性, 基本不会选择, 网络问题直接让整个系统不工作   |

> 需要明确的一点是, 对一个分布式系统而言, 分区容错性是一个基本的要求。因为既然是一个分布式系统, 那么分布式系统中的组件必然需要被部署到不同的节点, 否则也就无所谓分布式系统了，因此必然出现仔网络。对于分布式系统而言, 网络问题又是一个必定会出现的异常情况。一次分区容错性也就成为了一个分布式系统必然需要面对和解决的问题。

## BASE理论
BASE是`BASICALLY Available(基本可用)`, `Soft state(软状态)`和`Eventually Consistency(最终一致性)`三个短语的缩写. BASE理论是对CAP中一致性和可用性权衡的结果, 其来源与对大规模互联网系统分布式实践的总结, 是基于CAP定理逐步演化而来的。BASE理论的核心思想是: `即使无法做到强一致性, 单每个应用都可以根据自身业务特定, 采用适当的方式来使系统达到最终一致性。`

1. 基本可用
基本可用是指分布式系统在出现不可预知故障的时候, 允许损失部分可用性---这绝不等于系统不可用. 比如:
- 响应时间上的损失. 正常情况下, 一个在线搜索引擎需要在0.5秒之内返回给用户响应的查询结果, 但由于出现故障, 查询结果的响应时间增加了1~-2秒
- 系统功能上的损失: 正常情况下, 在一个电子商务网站上进行购物的时候, 消费者几乎能够顺利完成每一笔订单, 但是在一些节日大促购物高峰的时候, 由于消费者的购物行为激增, 为了保护购系统的稳定性, 部分消费者可能会被引导到降级界面。

2. 软状态
软状态指允许系统的数据存在中间状态, 并认为该中间状态的存在不会影响系统的整体可用性。即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时。

3. 最终一致性
最终一致性强调的是所有的数据副本, 在经过一段时间的同步之后, 最终都能达到一个一致的状态。因此, 最终一致性的本质是需要系统保证数据能够达到一致。而不需要实时保证数据的强一致性.
