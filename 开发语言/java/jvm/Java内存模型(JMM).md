# Java内存模型

JVM对内存区域的管理，主要包括五个方面：

- 堆
- 程序计数区
- 方法区
- 虚拟机栈
- 本地方法栈

![内存模型](.\内存模型.png)

## 堆

堆是JVM内存中最大的一块内存空间，该内存被所有线程共享。堆被划分为新生代和老年代，新生代又进一步划分为`Eden`和`Survivor`区域。最后`Survivor`由`From Survivor`和`To Survivor`组成.

![img](.\9906824978c891c86524f9394102de6c.png)

## 程序计数器（Program Counter Register)

程序计数器是一块很小的区域，主要用来记录各个线程执行的字节码地址，例如: 分支、循环、跳转、异常、线程恢复等都依赖于计数器。

由于Java是多线程语言，并且与系统线程是`1:1`的关系，当执行线程超过CPU核数时，线程之间会根据时间片轮训争夺CPU资源。如果一个线程时间片耗尽，或者其他原因导致线程CPU资源被抢夺，那么这个退出的线程需要一个单独的计数器，记录下一条运行的指令。

## 方法区(Method Area)

方法区主要是用来存放已被虚拟机加载的类相关信息。包括类信息、运行时常量池、字符串常量池。类信息又包括了类的版本、字段、方法、接口和父类等信息。

Jvm在执行类时、必须经过加载、连接、初始化。而连接又包括验证、准备、解析三个阶段、在类加载的时候，Jvm先加载class文件，而在class文件中除了有类的版本、字段、方法和接口等信息外、还有一项信息是常量池(Constant Pool Table)，用于存在变异期间生成的各种字面量和符号引用。

而当类加载到内存中，JVM就将class文件常量池中的内容存放到运行时的常量池中；在解析阶段，JVM会把符号引用替换为直接引用(对象的索引值)。

## 虚拟机栈

Java虚拟机栈是线程是有的内存空间，和Java线程一起创建。当创建一个线程时，会在虚拟机中申请一个线程栈，用来保存方法的局部变量、操作数栈、动态连接方法和返回地址等信息。并参与方法的调用和返回。每一个方法的调用都伴随着栈帧的入栈操作，返回则是栈帧的出栈操作。

## 本地方法栈

本地方法栈则用于管理本地方法的调用，但本地方法并不是用Java实现的，而是由C语言实现的。