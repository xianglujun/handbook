# 负载均衡

## 1. 指标

### 并发数

1. 并发的用户数，有一部分用户使用业务，另外一部分用户挂机，没有具体操作

2. 并发连接数。用户和服务器之间的连接，一部分连接在传输数据，一部分连接仅仅连接而已

3. 并发请求数，请求静态资源，有可能是写操作

4. 并发线程数，系统内，并发的线程数据

> 因此可以定义为同时服务的调用方的数量

### 吞吐量

> 单位时间内，能接受和返回的数据请求量

1. 看业务逻辑

2. 看请求的数据

### TPS: Transaction Per Second

> 每秒进行的事务的数目

### QPS: Queries Per Second 每秒的查询量

### 平均响应时间

> 从用户角度，关注的就是响应的时间(RTT): 即从发出请求到接受到响应所需要的时间。所有响应的平均值。

### 可靠性指标

> 平均无故障时间。系统上线，到第一次发生故障，运行时间的平均值。

### 公式计算

**<mark>阿姆达尔定律</mark>**：

加速比：优化前的响应时间/优化后的响应时间 r

增强比例：某个模块的响应时间/总时间 <= 1; p

整体系统的平均响应时间： t新 = t老时间 X ((1-P) + P/R)

系统整体的加速比： 1 / ((1-p) + p/r)

目的：优化P值大的系统，加大r

### 指标之间的关系

1. 并发数对吞吐量的关系：

2. 并发数对响应时间的影响：可能随着并发数的增加，响应数也增加

3. 用户角度：
   
   1. 并发数不受限制

4. 系统角度：因为用户并发数不受限制，因此对于系统是恶性循环

5. 可靠性指标和其他指标
   
   1. 其他指标越差，可靠性指标也就越差

### 优化方案

1. 并发数。减少并发数，防止系统并发数够高。
   
   1. 限流:    限制并发数量
   
   2. 分流：把指向一个系统的请求，分散到不同的系统上。
      
      1. 将请求到达系统的各个阶段，对请求进行分流
         
         1. DNS: 域名解析成IP地址，用户请求的第一次分叉(A记录：IP地址; CName记录：域名到域名)
            
            1. 减少系统并发数
            
            2. 让用户访问距离他租金的系统，降低网络延迟，减少平均响应时间

## 2. CDN

占用流量大，不经常发生改变。

- CDN节点、缓存节点、边缘节点

- 源站：起源的网站，最终的接受请求的网站

- 静态内容需要通过配置CND规则，决定那些数据需要缓存。

- 动态的内容还是需要去源站获取

### 优点

- 减小了系统并发数

- 减少了平均响应时间。距离用户近

- 减少了网络拥堵。网络分流，服务器的压力减小

### 原理

CDN通过`拦截`的方式对请求进行拦截：

知道用户发出的请求的Ip地址，就知道用户的位置，就能够找出距离用户最近的域名信息。

- 注册中心

- 请求实际服务

### 动态内容怎么处理？(源站的分流问题)

1. 源站将信息发送到注册中心

2. 用户发送请求的时候，从注册中心获取请求源站地址

3. 发送请求到源站

## 3. 负载均衡算法

- 轮询算法(Round Robin)：

- WRR(weighted 加权轮询)：随机数的范围。

- Least Connection(最小连接数)：**这个才是最符合负载均衡的算法**

- 源地址散列算法(source hashing)：来源地址，进行hash计算，如果原地址不变，目标ip地址也不变。会话相关，依赖上下文的功能，有状态的服务。
