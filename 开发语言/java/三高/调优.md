# 调优

## 可靠性

完全可靠，是不可能的

通过架构的手段提升可靠性。

失效概率：衡量时间。R(0) =1, R(正无穷)=0

### 模块的连接方式和可靠性

**串联系统的可靠性**：调用方：1，2,3,4,5 每个系统99%, 那么整体的可靠性: (5个99%相乘)：95%

**并联系统的可靠性**：r = 1 - (1-r1) * (1-r2) * (1-r3) * (1-r4)

**冗余系统可靠性**：5个模块，3个能用，就ok



> R 串 < R冗余 < R并联

### 可靠性设计

- 消除单点依赖：重要策略。

- 显式的串联该并联

- 集群：一个模块有效，则集群对外就是有效的
  
  - 主备式：
  
  - 等价式：

### 解决方案

#### 隔离

在调用链路中，如果某一个系统出现宕机或者不可用状态，可以通过以下方式隔离：

- **线程池**：取链接去调用

- **信号量**：

#### 限流

- **固定时间窗口**：
  
  - 规定一个时间：10秒 100个请求
  
  - 为了避免突刺，尽量缩小时间窗口，只要时间窗口足够小，小到只允许一个请求，就避免了突刺。

- **漏桶限流算法**：
  
  - 小到我给你的请求都能处理。
  
  - 以恒定的速率向服务发请求。
  
  - 容量有限
  
  - 缺点：
    
    - 服务处理不过来，会导致服务性能下降
    
    - 服务和漏下来的请求之间没有交互：要么我太忙，要么我太闲

- **令牌限流**
  
  - 请求要继续，需要拿到令牌。令牌由服务颁发。
  
  - 服务处理能力：统计请求的执行时间
  
  - 令牌发放时间：
    
    - 新的请求来：默认几个令牌
    
    - 令牌来，要有请求用

#### 降级

只保留必要的功能，

##### 降级策略

- 停止读取数据库：改成从缓存中读近似结果。商品已销售数量。(将准确结果转成近似结果。lbs location based server; 低精度；降低清晰度)

- 返回静态结果：返回结果固定

- 同步转异步：写缓存，mq

- 功能剪裁：

- 禁止写操作：不让用户该数据

- 分用户降级：

- 工作量证明降级：POW；

##### 触发手段

- 自动
  
  - 因失败概率过高。
  
  - 因限流而限流

- 手动

#### 熔断

我调用你，隔离：牺牲我，对资源进行隔离

响应慢，错误多，达到阈值，保险丝。

降级：是服务自身的行为

熔断：是否服务上游的行为，哪怕下一个请求能成功，我也不让你访问，自动完成。



#### 恢复

前面的措施都是暂时性的手段，为了保护系统

撤出限流，消除降级，关闭熔断。

感知系统正常，直接恢复。



- 预热（先少量开放）

- 恢复阶段：


