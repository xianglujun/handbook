# 临时表

## 创建方式

```sql
create temporary table temp_t like t1;
```

> 临时表可以使用各种引擎类型。如果是使用InnoDB引擎或者MyISAM引擎的临时表，写数据的时候是写到磁盘上的。

## 临时表的特性

- 建表语法是create temporary table ...
- 一个临时表只能被创建它的session访问，对其他线程不可见。当session结束时，会自动删除临时表
- 临时表可以与普通表同名
- 当一个session内有同名的临时表和普通表的时候，show create 语句，以及增删改查语句访问的是临时表
- show tables命令不显示临时表

### 临时表很适合join优化场景

- 不同session的临时表可以重名，如果有多个session同时执行join优化，不需要担心表名重复导致建表失败的问题
- 不需要担心数据删除问题。如果使用普通表，在流程执行过程中客户端发生了异常断开，或者数据库发生异常启动，还需要专门清理中间生成的数据表。而临时表由于会自动回收，所以不需要这个额外的操作。

## 临时表应用

在分库分表的场景中，市场涉及到将多个库上的数据进行关联查询并排序的需求。这是有两种方案可以实现：

- 通过中间层proxy从数据库中获取关联数据，然后在proxy层中对数据进行处理
  - 对Proxy开发的工作量比较大，如果设计到的操作比较复杂，比如group by 甚至join这样的操作，对中间层的开发能力要求比较高
  - 对proxy端的压力比较大，尤其是很容易出现内存不够用的和CPU瓶颈的问题
- 将数据汇总到一个MySQL实例表中，然后汇总实例上做逻辑操作
  - 创建临时表
  - 从每个实例上查询出结果
  - 将结果插入到临时表
  - 在临时表上执行归并操作

## 临时表与主备同步

由于主库在创建临时表的时候，会加上`sql{进程id}_{线程id}_序列号`,因此在主库中不同的session能够创建相同的临时表，然而在主备同步的过程中，存在两种情况：

- 当`binlog_format=row`的时候，对应的临时表的操作并不会记录到binlog中，因此主备同步没有问题
- 当`binlog_format=mixed/statement`时，创建以及删除临时表都会同步到从库，然后从库在执行同步的时候，相同的任务可能会分配到同样的线程，为了解决这个问题，mysql会在主库记录binlog的时候，记录主库的线程id, 这样从库执行时，就不会有表冲突的问题了。

## mysql如何区分不同的表

mysql在维护每个表的时候，会为每个表生成一个`table_def_key`值：

- 一个普通的表的`table_def_key`的值是由库名+表名的到的
- 而对于临时表， `table_def_Key`在库名+表名的基础上，又加入了`server_id+thread_id`

