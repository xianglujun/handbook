# Mysql SQL执行过程

## 建立链接

在SQL执行的第一步中，首先会与msql服务建立链接，其次对链接进行鉴权，最后从权限表中查出当前鉴权用户所拥有的权限。



### 自动关闭连接

mysql服务器会定期检查客户端连接，如果客户端太长时间没有执行操作，连接器就会自动断开，这个时间由参数`wait_timeout`控制，默认值为`8小时`



如果在链接呗断开之后，客户端再次发送请求时，就会手袋一个错误提醒: `Lost connection to MySQL server during query`. 这时候就需要重新链接，才能继续执行请求。

### 长连接

数据库里面，`长连接`是指链接成功后，如果客户端持续有请求，则一直使用同一个链接。

`短连接`则是指每次执行完很少的几次查询就断开链接，下次查询再重新建立一个。

建立链接的过程通常是比较复杂的，所以在使用中尽量减少建立链接的动作，也就是`尽量使用长连接`

如果全部使用长连接后，Mysql占用内存涨的特别快，这是因为MySQL在执行过程中临时使用的内存是管理在链接对象里面。这些资源会在`链接断开的时候才释放`。所以如果长连接累积下来，就可能导致`内存占用过大`, 被系统强行杀掉(`OOM`), 从现象看就是Mysql异常重启了。



### 长连接占用内存过大解决方案

1. 定期断开长连接。使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开链接，之后要查询再重连。
2. 如果MySQL 版本在`5.7`或更新版本，可以在每次执行一次比较大的操作后，通过执行`mysql_reset_connection`来重新初始化链接资源。这个过程不需要重连和重新做权限验证，但是会将链接恢复到刚刚创建完时的状态。

## 查询缓存

MySQL在获取到一个查询请求之后，会先到查询缓存查看，之前是否执行过这条语句。之前执行过的语句及其结果可能会以`key-value`对的方式，直接存储在内存中。`key`是查询语句。`value`是查询结果。如果查询能够直接在这个缓存中找到`key`, 那么这个`value`将会直接返回给客户端。



