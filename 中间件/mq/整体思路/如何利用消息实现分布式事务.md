# 如何利用消息中间件实现分布式事务?

## 解决场景

消息队列中的"事务", 主要解决的是消息生产者和消费者的数据一致性问题。



## 什么是分布式事务

如果我们需要对若干数据进行更新操作，为了保证这些数据的完整性和一致性，我们希望操作_***要么都成功，要么都失败***_。至于更新的数据，不只局限于数据库的数据，可以是磁盘上的一个文件，也可以是远端的一个服务，或者以其他形式存储的数据(概念上的理解)。



一个严格意义的事务实现, 应该具有4个属性: _原子性_, _一致性_, _隔离性_, _持久性_

- 原子性: 是指一个事务操作不可分割，要么成功，要么失败，不可能有一半成功一半失败的情况
- 一致性: 是指这些数据在事务执行完成这个时间点之前, 读到的一定是更新的数据，之后读到的一定是更新后的数据，不应该存在一个时刻，让用户读到更新过程中的数据。
- 隔离性: 是指一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对正在进行的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。
- 持久性: 是指一个事务一旦完成提交，后续的其他操作和故障都不会对事务的结果产生任何影响。

### 分布式事务方案

- 2PC (Two-phase Commit)
- TCC(Try-Confirm-Cancel)
- 事务消息

_事务消息_适用的场景主要是那些需要一部更新数据，并且对数据实时性要求不太高的场景。



### 消息队列时如何实现分布式事务

> 事务消息需要消息队列提供相应的功能才能实现，Kafka和RocketMQ都提供了事务相关功能。

一个在电商中的场景:

**当用户下单成功之后，需要将购物车中对应的商品移除购物车。**

- 首先系统在消息队列上开启一个事务, 然后订单系统给消息服务器发送一个"半消息", 这个半消息和普通消息唯一区别是, 在事务提交之前，对于消费者来说，这个消息时不可见的
- 





