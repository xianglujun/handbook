# 读隔离级别(Read Concern)

在读操作中，可以通过`readConcern`控制从副本集以及副本分片读取数据一致性和数据隔离性。

从mongodb 4.4版本开始，能够设置默认的全局读关注点(Read Concern), 当在具体操作中没有设置读关注点时，默认将从全局关注点继承。

## 1. 读关注点等级(Read Concern Level)

在mongodb中有几种读关注点等级可以使用，默认如下:

| 级别(level)    | 描述                                                                                                                                                                                                                                                                                                                                                                                                  |
| ------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| local        | 从一个实例返回查询文档数据，但是节点并不能保证数据已经写入大部分副本节点中，数据可能会回滚。如果在执行操作的时候，如果读取操作设置了`majority`的读关注点，此时才会保证数据已经写入了大多数副本节点。`local可以与非一致性事务和会话一起使用`                                                                                                                                                                                                                                                                      |
| available    | 该等级并不保证返回的数据已写入大部分副本中。该级别只保证文档数据在当前的实例中写入成功，因此该等级不能在一致性会话和事务中进行使用。在所有的读关注点级别中，available提供了低时延读取，但是低时延读取可能会存在读取孤立文档的风险，因此为了避免读取孤立文档，应当使用其他级别                                                                                                                                                                                                                                                         |
| majority     | majority保证了读取的文档是在副本中被大多数节点确认过的，因此及时文档发生失败，对读取数据也是没有影响的。majority能够在一致性读和事务中使用，同时也可以在非一致性事务和会话中使用。但是majority读取的时候，只能读取已经提交的事务，事务中的事务无法读取。该等级需要副本存储引擎为`WiredTiger`. 副本同步是通过`acknowledge`来实现的。                                                                                                                                                                                                         |
| linearizable | 该级别是在读取操作开始之前保证所有写操作数据已经被大多数副本确认，读取操作可能会等到写操作被大多数副本确认之后才会返回文档数据。<br/>如果在读取数据过程中，副本节点宕机或者发生重启，如果`writeConcernMajorityJournalDefault=true`此时mongodb将会等待数据被大多数副本确认后才会返回。<br/>如果`writeConcernMajorityJournalDefault=false`，mongodb将不会等待写操作完成并返回acknowledege, 此时可能会导致数据回滚。<br/>`linearizable`只有在指定文档唯一标识符的时候才会生效<br/>在使用该等级的操作时，应当配合`maxTimeMS`配合使用，防止大多数确认机制不可用，`maxTimeMS`保证在发生此种情况时，不会出现阻塞现象，并返回错误信息。 |
| snapshot     | `snapshot`级别是对`mongod`实例中的指定时间点的数据的完全复制，可以从整个集群、副本集、集群中的单个节点中读取文档<br/>如果事务是非一致性会话一部分，当写关注点为`majority`，在提交事务后，事务操作能够保证读取已提交数据的快照。<br/>如果事务是一致性会话一部分，当写关注点为`majority`，在提交事务基础上，事务操作保证从大多数已提交数据中读取快照，该快照保证了在事务开始前的一致性(这就有点像mysql中的可重复读的事务级别)。                                                                                                                                                          |

### 1.1 readConcern支持

#### 1.1.1 Read Concern 选项

当操作不是多文档事务时，能够指定`readConvern`级别作为选项，可以在方法参数指定实现`Read Concern`功能。

```shell
readConcern: { level: <level> }
```

在mongo的shell中，我们可以通过`readConcern()`方法设置级别，例如:

```shell
db.collection.find().readConcern(<level>)
```

#### 1.1.2 事务和可用读关注点

对于多文档事务操作，只能够将读关注点设置在事务级别上，不能设置在单个操作级别。在事务中的操作只能使用事务级别读关注点。在事务中集合和数据库级别上的读关注点将被忽略。如果事务级别的读关注点被明确的指定，那么客户端的读关注点将被忽略。

在事务开始时，我们可以指定读关注点:

- 对于多文档事务，以下读关注点可以被使用：
  
  - local
  
  - majority
  
  - snapshot

- 多文档事务写命令，能够支持事务级别的读关注

- 从4.4版本开始，在事务中能够创建集合和索引，如果在事务中明确创建了集合或者索引，那么读关注点必须为`local`, 如果是隐式的创建结合和索引，则能够使用所有可用的读关注点。

> 读关注点优先级:
> 
> - transaction-level: 在事务开始时，设置的事务级别的读关注
> 
> - session-level: 会话级别的读关注
> 
> - client-level: 客户端级别的读关注

#### 1.1.3 一致性会话和读关注点(Read Concern)

在事务一致性会话操作中，`local`和`majority`级别读关注点是可以使用的。然后为了保证一致性读关注，则必须使用`majority`

如果在一致性会话中包含了多文档操作，在事务中也是能够使用`snapshot`级别读关注。

> 为了在事务中设置读关注点，我们应该将读关注点设置在事务级别上(transaction-level)，而不是单个操作级别上(operation-level)。

| Command/Method                                                                                                                                                                                                                                                            | [`"local"`](https://www.mongodb.com/docs/v4.4/reference/read-concern-local/#mongodb-readconcern-readconcern.-local-) | [`"available"`](https://www.mongodb.com/docs/v4.4/reference/read-concern-available/#mongodb-readconcern-readconcern.-available-) | [`"majority"`](https://www.mongodb.com/docs/v4.4/reference/read-concern-majority/#mongodb-readconcern-readconcern.-majority-) | [`"snapshot"`](https://www.mongodb.com/docs/v4.4/reference/read-concern-snapshot/#mongodb-readconcern-readconcern.-snapshot-)[[3]](https://www.mongodb.com/docs/v4.4/reference/read-concern/#footnote-snapshot) | [`"linearizable"`](https://www.mongodb.com/docs/v4.4/reference/read-concern-linearizable/#mongodb-readconcern-readconcern.-linearizable-) |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| [`count`](https://www.mongodb.com/docs/v4.4/reference/command/count/#mongodb-dbcommand-dbcmd.count)                                                                                                                                                                       | ✓                                                                                                                    | ✓                                                                                                                                | ✓                                                                                                                             |                                                                                                                                                                                                                 | ✓                                                                                                                                         |
| [`distinct`](https://www.mongodb.com/docs/v4.4/reference/command/distinct/#mongodb-dbcommand-dbcmd.distinct)                                                                                                                                                              | ✓                                                                                                                    | ✓                                                                                                                                | ✓                                                                                                                             | ✓ [[2]](https://www.mongodb.com/docs/v4.4/reference/read-concern/#footnote-distinct)                                                                                                                            | ✓                                                                                                                                         |
| [`find`](https://www.mongodb.com/docs/v4.4/reference/command/find/#mongodb-dbcommand-dbcmd.find)                                                                                                                                                                          | ✓                                                                                                                    | ✓                                                                                                                                | ✓                                                                                                                             | ✓                                                                                                                                                                                                               | ✓                                                                                                                                         |
| [`db.collection.find()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.find/#mongodb-method-db.collection.find) via [`cursor.readConcern()`](https://www.mongodb.com/docs/v4.4/reference/method/cursor.readConcern/#mongodb-method-cursor.readConcern) | ✓                                                                                                                    | ✓                                                                                                                                | ✓                                                                                                                             | ✓                                                                                                                                                                                                               | ✓                                                                                                                                         |
| [`geoSearch`](https://www.mongodb.com/docs/v4.4/reference/command/geoSearch/#mongodb-dbcommand-dbcmd.geoSearch)                                                                                                                                                           | ✓                                                                                                                    | ✓                                                                                                                                | ✓                                                                                                                             | ✓                                                                                                                                                                                                               | ✓                                                                                                                                         |
| [`getMore`](https://www.mongodb.com/docs/v4.4/reference/command/getMore/#mongodb-dbcommand-dbcmd.getMore)                                                                                                                                                                 | ✓                                                                                                                    |                                                                                                                                  |                                                                                                                               |                                                                                                                                                                                                                 | ✓                                                                                                                                         |
| [`aggregate`](https://www.mongodb.com/docs/v4.4/reference/command/aggregate/#mongodb-dbcommand-dbcmd.aggregate) [`db.collection.aggregate()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.aggregate/#mongodb-method-db.collection.aggregate)         | ✓                                                                                                                    | ✓                                                                                                                                | ✓                                                                                                                             | ✓                                                                                                                                                                                                               | ✓ [[6]](https://www.mongodb.com/docs/v4.4/reference/read-concern/#footnote-6)                                                             |
| [`Session.startTransaction()`](https://www.mongodb.com/docs/v4.4/reference/method/Session.startTransaction/#mongodb-method-Session.startTransaction)                                                                                                                      | ✓                                                                                                                    |                                                                                                                                  | ✓                                                                                                                             | ✓                                                                                                                                                                                                               |                                                                                                                                           |

如果操作是多文档事务的一部分，一下操作也是可以支持读关注点:

| Command                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | [`"local"`](https://www.mongodb.com/docs/v4.4/reference/read-concern-local/#mongodb-readconcern-readconcern.-local-) | [`"available"`](https://www.mongodb.com/docs/v4.4/reference/read-concern-available/#mongodb-readconcern-readconcern.-available-) | [`"majority"`](https://www.mongodb.com/docs/v4.4/reference/read-concern-majority/#mongodb-readconcern-readconcern.-majority-) | [`"snapshot"`](https://www.mongodb.com/docs/v4.4/reference/read-concern-snapshot/#mongodb-readconcern-readconcern.-snapshot-)[[3]](https://www.mongodb.com/docs/v4.4/reference/read-concern/#footnote-snapshot) | [`"linearizable"`](https://www.mongodb.com/docs/v4.4/reference/read-concern-linearizable/#mongodb-readconcern-readconcern.-linearizable-) |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| [`delete`](https://www.mongodb.com/docs/v4.4/reference/command/delete/#mongodb-dbcommand-dbcmd.delete)<br><br>[`db.collection.deleteMany()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.deleteMany/#mongodb-method-db.collection.deleteMany)<br><br>[`db.collection.deleteOne()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.deleteOne/#mongodb-method-db.collection.deleteOne)<br><br>[`db.collection.remove()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.remove/#mongodb-method-db.collection.remove)                                                                                                                                                                                                                                                                   | ✓                                                                                                                    |                                                                                                                                  |                                                                                                                               | ✓                                                                                                                                                                                                               |                                                                                                                                           |
| [`findAndModify`](https://www.mongodb.com/docs/v4.4/reference/command/findAndModify/#mongodb-dbcommand-dbcmd.findAndModify)<br><br>[`db.collection.findAndModify()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.findAndModify/#mongodb-method-db.collection.findAndModify)<br><br>[`db.collection.findOneAndDelete()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.findOneAndDelete/#mongodb-method-db.collection.findOneAndDelete)<br><br>[`db.collection.findOneAndReplace()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.findOneAndReplace/#mongodb-method-db.collection.findOneAndReplace)<br><br>[`db.collection.findOneAndUpdate()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.findOneAndUpdate/#mongodb-method-db.collection.findOneAndUpdate) | ✓                                                                                                                    |                                                                                                                                  |                                                                                                                               | ✓                                                                                                                                                                                                               |                                                                                                                                           |
| [`insert`](https://www.mongodb.com/docs/v4.4/reference/command/insert/#mongodb-dbcommand-dbcmd.insert)<br><br>[`db.collection.insert()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.insert/#mongodb-method-db.collection.insert)<br><br>[`db.collection.insertOne()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.insertOne/#mongodb-method-db.collection.insertOne)<br><br>[`db.collection.insertMany()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.insertMany/#mongodb-method-db.collection.insertMany)                                                                                                                                                                                                                                                                   | ✓                                                                                                                    |                                                                                                                                  |                                                                                                                               | ✓                                                                                                                                                                                                               |                                                                                                                                           |
| [`update`](https://www.mongodb.com/docs/v4.4/reference/command/update/#mongodb-dbcommand-dbcmd.update)<br><br>[`db.collection.update()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.update/#mongodb-method-db.collection.update)<br><br>[`db.collection.updateMany()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.updateMany/#mongodb-method-db.collection.updateMany)<br><br>[`db.collection.updateOne()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.updateOne/#mongodb-method-db.collection.updateOne)<br><br>[`db.collection.replaceOne()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.replaceOne/#mongodb-method-db.collection.replaceOne)                                                                                                       | ✓                                                                                                                    |                                                                                                                                  |                                                                                                                               | ✓                                                                                                                                                                                                               |                                                                                                                                           |
| [`create`](https://www.mongodb.com/docs/v4.4/reference/command/create/#mongodb-dbcommand-dbcmd.create)<br><br>[`db.createCollection()`](https://www.mongodb.com/docs/v4.4/reference/method/db.createCollection/#mongodb-method-db.createCollection)<br><br>(Requires [fCV](https://www.mongodb.com/docs/v4.4/reference/command/setFeatureCompatibilityVersion/#std-label-view-fcv) 4.4 or greater)                                                                                                                                                                                                                                                                                                                                                                                                                                            | ✓                                                                                                                    |                                                                                                                                  |                                                                                                                               |                                                                                                                                                                                                                 |                                                                                                                                           |
| [`createIndexes`](https://www.mongodb.com/docs/v4.4/reference/command/createIndexes/#mongodb-dbcommand-dbcmd.createIndexes)<br><br>[`db.collection.createIndex()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.createIndex/#mongodb-method-db.collection.createIndex)<br><br>[`db.collection.createIndexes()`](https://www.mongodb.com/docs/v4.4/reference/method/db.collection.createIndexes/#mongodb-method-db.collection.createIndexes)<br><br>(Requires [fCV](https://www.mongodb.com/docs/v4.4/reference/command/setFeatureCompatibilityVersion/#std-label-view-fcv) 4.4 or greater)                                                                                                                                                                                                                                | ✓                                                                                                                    |                                                                                                                                  |                                                                                                                               |                                                                                                                                                                                                                 |                                                                                                                                           |

#### 1.1.4 读关注点不支持本地数据库

mongodb本地数据库不支持读关注点，mongodb默认会忽略所有的读关注点的配置信息。
