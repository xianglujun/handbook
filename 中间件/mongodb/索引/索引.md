# 索引

## 1. 索引概念

在mongodb中，索引能够使查询更加高效。在没有索引时，查询必须遍历整个集合。索引是一个特殊的数据结构，存储了文档的部分字段数据，并能够快速执行遍历操作。索引不仅存储了索引字段具体的值，同时存储的值，也按照一定顺序排列。索引的有序性能够快速的执行等值和范围查询，并且通过索引能够保证在返回数据时的顺序性。

### 1.1 索引分类

所以主要包含了一下几种分类：

- Single Field: 单字段索引

- Compound Index: 组合索引，针对多个字段创建索引

- Multikey Index: 针对数组的索引方式

- Geospatial Index: 针对地理位置索引

- Text Index: 全文索引

- Hashed Index: hash索引

### 1.2 索引属性（Index Properties）

- Unique Indexes: 唯一索引，主要保证字段的值不会有重复值。除了唯一性约束，唯一索引可以和其他索引在功能上互换。

- Partial Indexes: 部分索引，部分索引紧紧为集合中满足指定表达是的文档建立索引，通过索引文档子集，部分索引具有更低的性能要求，并降低了创建索引和维护索引的性能成本。部分索引提供了稀疏索引的超集，应该优先于 稀疏索引。

- Sparse Indexes：稀疏索引，稀疏索引保证了只有索引字段会被存储在索引的数据结构中，自动跳过了没有添加索引的字段。稀疏索引可以配合唯一索引实现数据的重复插入和跳过缺失索引字段的文档数据

- TTL Indexes: TTL Indexes是一个特殊的索引，能够在一定时间之后将文档数据删除。主要用于存储时间，日志，session等数据

- Hidden Indexes: 该索引是一个特殊的索引，该索引不会被查询计划使用，并不能提升查询的性能。主要适用于逻辑删除索引，除了`_id`主键索引外，其他索引都可以使用。

## 2. 单字段索引

mongodb对于单字段有比较全的类型支持，在所有的结合中，都会有一个`_id`字段的主索引，用户可以自定义索引以支持不同的操作和查询。

![](../../../assets/76c0c68a61433858fc02225534c0c17fd7236a94.svg)

### 2.1 在单个字段上创建索引

这里还是以前面的inventory结果为例，则测试数据样例如下:

```shell
db.inventory.insertMany([
   { item: "journal", qty: 25, tags: ["blank", "red"], size: { h: 14, w: 21, uom: "cm" } },
   { item: "mat", qty: 85, tags: ["gray"], size: { h: 27.9, w: 35.5, uom: "cm" } },
   { item: "mousepad", qty: 25, tags: ["gel", "blue"], size: { h: 19, w: 22.85, uom: "cm" } }
])
```

通过以上数据，我们为`inventory`集合的`qty`创建一个升序的索引，则对应创建语句如下:

```shell
db.inventory.createIndex({qty: 1})
```

当索引创建成功后，则`qty`字段将支持索引查询，例如:

```shell
db.inventory.find({qty: 85})
db.inventory.find({qty: {$gt: 50}})
```

### 2.2 在嵌套文档属性上创建索引

在嵌套文档中，也可以在嵌套文档字段中创建索引，一样具有索引的功能。我们可以通过`.`的语义表达式为嵌套文档字段创建索引信息，具体定义如下:

```shell
db.inventory.createIndex({"size.h": 1})
```

则可以根据嵌套字段过滤数据:

```shell
 db.inventory.find({"size.h": 19})
 db.inventory.find({"size.h": 19, "size:w": 22.85})
```

### 2.3 在嵌套文档上创建索引

mongodb可以在整个嵌套文档上创建索引, 具体语法如下:

```shell
db.inventory.createIndex({size: 1})
```

则可以通过`size`字段查询文档数据信息，则对应查询语句为：

```shell
 db.inventory.find({"size.w": 19})
```

对于索引的命中可以通过`explain()`方法查询执行计划，索引的命中情况，则对应语句为:

```shell
 db.inventory.find({"size.w": 19}).explain()
```

## 3. 聚合索引

mongodb支持聚合索引，也就是一个索引结构上有多个文档字段，则组合索引的组成结构如下:

![](../../../assets/9cfe38bb928dbd720f83d1c79c2bfa519c971d91.svg)

### 3.1 创建组合索引

可以通过如下的语法创建组合索引:

```shell
db.collection.createIndex( { <field1>: <type>, <field2>: <type2>, ... } )
```

在以上的语法中，value描述了对应字段的索引类型。例如，当对应值为1的时候，表示索引按照升序排列。当值为-1的时候按照倒叙排列。在mongodb中索引的对应类型有很多中，可以查看对应的文档。

> 在热点索引上面，索引字段的顺序对于性能有很大的影响。这就跟mysql中左前缀索引类似。

> 从4.4版本开始：
> 
> - 组合索引字段中可能包含了hash索引的字段
> 
> - 当创建聚合索引的时候，如果多个字段都是hash索引时，将会报错
> 
> 在4.2版本之前：
> 
> - 组合索引中可能不会包含hash索引的字段
> 
> - 在创建组合索引的时候，如果组合索引字段中包含了hash索引，则会报错

例如，以官方文档中的例子实现:

```shell
db.products.insertMany([
  {
 "item": "Banana",
 "category": ["food", "produce", "grocery"],
 "location": "4th Street Store",
 "stock": 4,
 "type": "cases"
},
{
 "item": "apple",
 "category": ["food", "produce"],
 "location": "2th Street Store",
 "stock": 20,
 "type": "cases"
}
])
```

插入两个产品信息到集合中，在item和stock上创建一个组合索引，字段均是正序排列，则对应的创建语句为:

```shell
db.products.createIndex( { "item": 1, "stock": 1 } )
```

则使用组合索引查询文档数据，查询语句为：

```shell
db.products.find( { item: "Banana" } )
db.products.find( { item: "Banana", stock: { $gt: 5 } } )
```

### 3.2 排序

针对单个字段的索引来说，字段的排序其实并不会有太大的影响，因为mongodb可以通过遍历key实现。但是组合索引就会比较大的影响，聚合索引的顺序会影响查询和排序操作是否生效。

假设events集合中有`username`和`date`的字段，我们可以通过查询结果，按照`username`升序和`date`降序返回，则对应的查询为：

```shell
db.events.find().sort( { username: 1, date: -1 } )
```

或者events集合按照username倒序和date升序返回结果集, 则对应的查询结果为:

```shell
db.events.find().sort( { username: -1, date: 1 } )
```

以上情况，都可以通过创建索引实现，则对应的索引为:

```shell
db.events.createIndex( { "username" : 1, "date" : -1 } )
```

但是索引却不能实现按照`username`升序和`date`升序排列，也即:

```shell
db.events.find().sort( { username: 1, date: 1 } )
```

### 3.3 左前缀索引

左前缀索引是指查询的字段为索引字段列表的开始子集，例如有如下索引的定义：

```shell
{ "item": 1, "location": 1, "stock": 1 }
```

则左前缀索引包含了一下的情况

- `{ item: 1 }`

- `{ item: 1, location: 1 }`

在查询的时候，可以通过左前缀所以来提升查询的效率。只是左前缀索引效率并没有全匹配的索引效率高。也即可以通过`item`和`location`过滤文档数据，一样的可以使用到索引。

如果查询的过程中，跳过了某个中间的字段，如`item`和`stock`进行查询，这个时候并不能命中`stock`索引，而只能使用`item`索引进行查询和过滤。

在以下的查询中，将会导致索引失效，例如

- 使用location查询

- 使用stock查询

- 使用location和stock查询

## 4. MultiKey 索引

当文档字段为数组值时，mongodb为数组中的每个元素创建一个索引，MultiKey所以支持标量数组(例如字符串，数字)和嵌套文档。所以对应的组织结构图为：

![](../../../assets/a8f11f16f4927a7a46706da034d035be9a4d2cbd.svg)

### 4.1 创建MultiKey索引

可以通过`db.collection.createIndex()`方法创建索引，则对应的创建语法为：

```shell
db.coll.createIndex( { <field>: < 1 or -1 > } )
```

当创建的字段类型为数组时，则自动创建multikey所以，在创建的时候，无需显式的指定索引类型。


