# 高可用实现

## 副本集选举

副本集选举值当primary不可用时，从副本集成员中选举出新的primary节点。副本集群在一下的条件满足的时候，将会触发选举:

- 向副本集群中添加新的节点

- 初始化副本集

- secondary节点丢失了primary连接，并在超过配置的时间(默认10秒)仍然未恢复

![](../../../assets/8402994c3beef23d01f2a3ef1cfdee3dacb02fc1.svg)

这个图示展示了副本集中的选举过程。

> 当副本集群正在处于选举过程中时，不能够继续执行写入操作。相反，如果查询操作指定了在secondary上执行的时候，则仍然可以执行查询操作。

当集群采用默认配置的时候，选举新的Primary节点所需的时间不应该超过12秒。在默认的配置中，该时间主要包含了标记primary节点为不可用并完成选举操作。该配置时间可以修改默认的配置[`settings.electionTimeoutMillis`](https://www.mongodb.com/docs/v4.4/reference/replica-configuration/#mongodb-rsconf-rsconf.settings.electionTimeoutMillis),但是网络延迟等因素可能会导致选举的时间变长，进而影响没有primary节点的运行时间。

从应用层面应该能够自动探测到选举的过程，从3.6版本开始，驱动能够探测到primary不可用并且自动重试写操作。

- mongodb4.2+开始，默认会重试写操作

- 4.0和3.6版本则需要手动开启重试的机制，以实现重试的效果

## 影响选举因素和条件

### 选举协议

> 在4.0版本的时候，移除以了已经过期的协议版本

当`protocalVersion:1`减少了副本集群的失败时间，并加速了对多个节点的检测。

`protocalVersion:1`协议可以使用`catchUpTimeoutMillis`在集群异常和写入`w:1`操作之间做优先级整理。

### 心跳(heartbeat)

在集群中，集群中的成员互相通过心跳的方式保持通信。默认配置，心跳每2秒发送一次。当心跳信息在10秒内没有收到回复，将吧对应的节点标记为不可用。

### 成员优先级

在副本集中已经存在稳定的primary节点后，副本集将尽最大的可能从高优先的secondary节点中进行选举。在高优先级的secondary节点中，比低优先级的secondary节点选举更快。在没有高优先级的secondary节点时，也是可以从低优先级的secondary节点中选举为primary.只是在更高优先级的secondary回复正常后，将继续进行选举。

### 镜像读

从mongodb4.4版本开始，提供了镜像读的功能。镜像读是指缓存可被选举的secondary节点最近读取的数据，帮助在secondary选举完成后能够尽快的提供性能支持。这些缓存在被记录后，会发送到secondary节点。

### 数据中心丢失

对于分布式副本集，数据中心的丢失可能会影响数据中心或者数据中心的剩余成员的选举能力。如果可能，请将副本集成员分不到数据中心，以最大限度的提高即使数据中心丢失，剩余副本集成员也能成为新的副本集成员的可能性。


