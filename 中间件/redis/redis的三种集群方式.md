# redis的三种集群方式
## 主从复制
### 主从复制原理
- 从服务器链接主服务器, 发送SYNC命令
- 主服务器收到SYNC命令后, 开始执行BGSAVE名称RDB文件并使用缓冲区记录伺候执行的所有写命令;
- 主从服务器BGSAVE执行完成后, 向所有从服务器发送快照文件, 并在发送期间继续记录被执行的写命令(异步同步数据);
- 从服务器收到快照文件后丢弃所有旧数据, 载入收到的快照
- 注服务器快照发送完毕后开始想从服务器发送缓冲区中的写命令
- 从服务器完成对快照的载入, 开始接受命令请求, 并执行来自主服务器缓冲区的写命令(从服务器初始化完成)
- 主服务器每执行一个写命令, 就会想从服务器发送相同的写命令, 从服务器接受并执行收到的写命令(从服务器初始化完成后的操作)

### 主从复制优缺点
#### 优点
- 支持主从复制, 主机会自动将数据同步到从机, 可以进行读写分离.
- 为了分载Master的读操作压力, Slave服务器可以为客户端提供只读操作的服务, 写服务器仍然`必须由Master来完成`
- Slave同样可以接受其它Slaves的连接和同步请求, 这样可以有效的分载Master的同步压力
- Master Server以非阻塞的方式为Slaves提供服务。所以在Master-slave同步期间, 客户端仍然可以提交查询和修改请求
- Slave Server同样是以非阻塞的方式完成数据同步. 在同步期间, 如果有客户端提交查询请求, Redis则返回同步之前的数据

#### 缺点
- Redis不具备`自动容错`和`恢复功能`， 主机从机的宕机都会导致前端部分读写请求失败. 需要等待机器重启或者手动切换前端的IP才能恢复
- 主机宕机, 宕机前有部分数据未能及时同步到从机, 切换IP后还会引入数据不一致的问题, 降低了系统的可用性
- Redis较难支持在线扩容, 在集群容量达到上限时在线扩容会变得很复杂


## 哨兵模式
当主服务器中断服务后, 可以将一个从服务器升级为主服务器, 以便继续提供服务。但是这个工程需要人工手动来操作。为此, Redis2.8中提供了哨兵工具来实现自动化的系统监控和故障恢复功能

哨兵的作用就是监控Redis系统运行状况, 它的功能包括以下两个:
(1) 监控主服务器和从服务器是否正常运行
(2) 主服务器出现故障时自动将从服务器转换为主服务器

### 哨兵的工作方式
- 每个Sentinel(哨兵)进程已每秒钟一次的频率想向个集群中的Master主服务器, Slave从服务器以及其他Sentinel(哨兵)进程发送Ping 命令
- 如果一个实例(instance)距离最后一次有效回复PING命令的时间超过`down-after-milliseconds`选项所指定的值, 则这个实例会被Sentinel(哨兵)进程标记为`主观下线(SDOWN)`
- 如果一个Master主服务器被标记为主观下线（SDOWN）, 则正在监视这个Master主服务器的所有Sentinel进程要以每秒一次的频率确认Master主服务器的确进入了主观下线状态
- 当有足够数量的Sentinel进程(大于等于配置文件指定的值)在指定时间范围内确认Master主服务器进入了主观下线状态(SDOWN), 则Master主服务器会被标记为可观下线(ODOWN)
- 在一般情况下, 每个Sentinel进程会以每10秒一次的频率想集群中所有Master主服务器, Slave从服务器发送INFO命令
- 当Master主服务器被Sentinel进程标记为可观下线时(ODOWN), Senitel进程向下线的Master主服务器的所有Slave从服务器发送INFO命令的频率会从10秒改为每秒1次
- 若没有足够数量的Sentinel进程同意Master主服务器下线, Master主服务器的客观下线状态就会被移除。若Master主服务器重新向Sentinel进程发送PING命令返回有效回复, Master主服务器的主观下线状态就会被移除.

### 哨兵模式的优缺点
#### 优点
- 哨兵模式是基于主从模式的, 所有的主从的有点, 哨兵模式都具有
- 主从可以自动切换, 系统更健壮, 可用性更高

#### 缺点
- Redis较难支持在线扩容, 在集群容量达到上限时在线扩容会变得很复杂

## Redis-Cluster集群
redis的哨兵模式基本已经可以实现高可用, 读写分离, 但是这种模式下每台redis服务器都存储相同的数据, 很烂费内存,所以在redis3.0上加入了cluster模式, 实现的redis的分布式存储，也就是说每台redis节点上存储不同的内容

### Redis-Cluster采用无中心结构, 它的特点如下:
- 所有的redis节点彼此互联(PING-PONG机制), 内部使用二进制协议优化传输速度和贷款
- 节点的fail是通过集群中超过半数的接到此案检测失效时才生效
- 客户端与redis节点直连, 不需要中间代理层, 客户端不需要链接集群的所有节点, 链接集群中任何一个可用节点即可

### 工作方式
在redis的每一个节点上, 都有这么两个东西
- 插槽(slot): 取值范围是: 0-16383
- Cluster: 可以理解为集群管理插件
- 当我们存取的key到达的时候, redis会根据crc16的算法得出一个结果, 然后把结果对`16384`求余数(取模), 这样每个key都会对应一个编号在0-16383之间的哈希槽, 通过这个值, 去找到对应的插槽所对应的节点, 然后直接跳转到这个对应的节点上进行存取
- 为了保证高可用, redis-cluster集群引入了主从模式, 一个节点对应一个或多个从节点, 当主节点宕机的时候, 就汇启用从节点。当其他主节点PING一个主节点A时, 如果半数以上的主节点与A通信超时, 那么认为主节点A宕机了。如果主节点A和它的从节点A1都宕机了，那么该集群就无法再提供服务了。
